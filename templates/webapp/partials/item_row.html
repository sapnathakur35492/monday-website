{% load webapp_tags %}
<tr id="item-{{ item.id }}" class="group hover:bg-slate-50 border-t border-slate-200 animate-slide-up">
    <td class="border-r border-slate-200" style="border-left: 6px solid {{ item.group.color }}"></td>
    <td class="px-4 py-2 border-r border-slate-200 font-medium text-slate-800 group-hover:text-indigo-600 transition-colors cursor-pointer"
        hx-get="{% url 'get_item_details' item.id %}" hx-target="#side_panel_content" hx-swap="innerHTML">
        {{ item.name }}
        <span
            class="ml-2 px-1.5 py-0.5 rounded-full bg-slate-100 text-[10px] text-slate-400 border border-slate-200 group-hover:bg-indigo-50 group-hover:text-indigo-500">Open</span>
    </td>
    {% for col in columns %}
    <td class="px-0 py-0 border-r border-slate-200 text-center text-slate-600 align-middle h-full">
        <!-- Status Cell Logic -->
        <!-- Status Cell Logic -->
        {% with val=item.values|get_value:col.id %}
        {% if col.type == 'status' %}

        <div x-data="{ 
            open: false, 
            currentVal: '{{ val|default:'Label' }}',
            statusColors: {
                'Done': 'bg-green-500 shadow-sm text-white',
                'Working on it': 'bg-amber-400 text-white',
                'Stuck': 'bg-red-500 text-white',
                'In Progress': 'bg-blue-400 text-white',
                'Not Started': 'bg-slate-300 text-slate-600',
                'On Hold': 'bg-slate-400 text-white',
                'Label': 'bg-slate-300 text-slate-600'
            },
            changeStatus(newVal) {
                this.currentVal = newVal;
                this.open = false;
                if (newVal === 'Done') {
                    // Trigger global confetti
                    if (window.confetti) {
                        confetti({
                             particleCount: 150,
                             spread: 100,
                             origin: { y: 0.6 },
                             colors: ['#22c55e', '#ec4899', '#f59e0b']
                        });
                    }
                }
            }
        }" class="relative w-full h-full min-h-[40px]">

            <!-- Current Value Display -->
            <div @click="open = !open" :class="statusColors[currentVal] || 'bg-slate-300 text-slate-600'"
                class="w-full h-full flex items-center justify-center font-medium text-xs uppercase tracking-wide cursor-pointer hover:opacity-90 transition-opacity">
                <span x-text="currentVal"></span>
            </div>

            <!-- Dropdown Menu -->
            <div x-show="open" @click.outside="open = false" style="display: none;"
                class="absolute top-full left-0 w-[160px] z-50 bg-white rounded-md shadow-xl border border-slate-200 py-1 mt-1 font-sans">

                <!-- Helper to iterate choices -->
                {% with choices=col.settings.choices|default:'' %}
                {% if choices %}
                {% for choice in choices %}
                <div @click="changeStatus('{{ choice }}')" hx-post="{% url 'update_status' item.id col.id %}"
                    hx-vals='{"action_value": "{{ choice }}"}' hx-target="#item-{{ item.id }}" hx-swap="outerHTML"
                    class="px-4 py-2 text-sm text-slate-700 hover:bg-indigo-50 cursor-pointer flex items-center gap-2">
                    <span class="w-3 h-3 rounded-full" :class="statusColors['{{ choice }}'] || 'bg-slate-300'"></span>
                    {{ choice }}
                </div>
                {% endfor %}
                {% else %}
                <!-- FALLBACKS if no choices defined in DB -->
                <div @click="changeStatus('Not Started')" hx-post="{% url 'update_status' item.id col.id %}"
                    hx-vals='{"action_value": "Not Started"}' hx-target="#item-{{ item.id }}" hx-swap="outerHTML"
                    class="px-4 py-2 hover:bg-slate-100 cursor-pointer text-sm">Not Started</div>
                <div @click="changeStatus('Working on it')" hx-post="{% url 'update_status' item.id col.id %}"
                    hx-vals='{"action_value": "Working on it"}' hx-target="#item-{{ item.id }}" hx-swap="outerHTML"
                    class="px-4 py-2 hover:bg-slate-100 cursor-pointer text-sm">Working on it</div>
                <div @click="changeStatus('Stuck')" hx-post="{% url 'update_status' item.id col.id %}"
                    hx-vals='{"action_value": "Stuck"}' hx-target="#item-{{ item.id }}" hx-swap="outerHTML"
                    class="px-4 py-2 hover:bg-slate-100 cursor-pointer text-sm">Stuck</div>
                <div @click="changeStatus('Done')" hx-post="{% url 'update_status' item.id col.id %}"
                    hx-vals='{"action_value": "Done"}' hx-target="#item-{{ item.id }}" hx-swap="outerHTML"
                    class="px-4 py-2 hover:bg-slate-100 cursor-pointer text-sm">Done</div>
                {% endif %}
                {% endwith %}
            </div>
        </div>

        {% elif col.type == 'priority' %}
        <div x-data="{ 
            open: false, 
            currentVal: '{{ val|default:'-' }}',
            priorityColors: {
                'High': 'bg-red-100 text-red-700',
                'Critical': 'bg-red-200 text-red-800',
                'Medium': 'bg-amber-100 text-amber-700',
                'Low': 'bg-green-100 text-green-700',
                'Normal': 'bg-slate-100 text-slate-700',
                '-': 'bg-slate-50 text-slate-400'
            },
            changePriority(newVal) {
                this.currentVal = newVal;
                this.open = false;
            }
        }" class="h-full px-2 flex items-center justify-center relative">

            <span @click="open = !open"
                class="px-2 py-1 rounded-full text-xs font-semibold cursor-pointer hover:shadow-sm transition-all border border-transparent hover:border-slate-200"
                :class="priorityColors[currentVal] || 'bg-slate-100 text-slate-600'" x-text="currentVal">
            </span>

            <!-- Priority Dropdown -->
            <div x-show="open" @click.outside="open = false" style="display: none;"
                class="absolute top-full left-0 w-[140px] z-50 bg-white rounded-md shadow-xl border border-slate-200 py-1 mt-1 font-sans text-left">

                <!-- Hardcoded Defaults for Priority since we didn't add DB settings yet -->
                <div @click="changePriority('Critical')" hx-post="{% url 'update_status' item.id col.id %}"
                    hx-vals='{"action_value": "Critical"}' hx-target="#item-{{ item.id }}" hx-swap="outerHTML"
                    class="px-3 py-2 hover:bg-red-50 text-red-700 cursor-pointer text-xs font-medium">Critical</div>
                <div @click="changePriority('High')" hx-post="{% url 'update_status' item.id col.id %}"
                    hx-vals='{"action_value": "High"}' hx-target="#item-{{ item.id }}" hx-swap="outerHTML"
                    class="px-3 py-2 hover:bg-red-50 text-red-600 cursor-pointer text-xs font-medium">High</div>
                <div @click="changePriority('Medium')" hx-post="{% url 'update_status' item.id col.id %}"
                    hx-vals='{"action_value": "Medium"}' hx-target="#item-{{ item.id }}" hx-swap="outerHTML"
                    class="px-3 py-2 hover:bg-amber-50 text-amber-600 cursor-pointer text-xs font-medium">Medium</div>
                <div @click="changePriority('Low')" hx-post="{% url 'update_status' item.id col.id %}"
                    hx-vals='{"action_value": "Low"}' hx-target="#item-{{ item.id }}" hx-swap="outerHTML"
                    class="px-3 py-2 hover:bg-green-50 text-green-600 cursor-pointer text-xs font-medium">Low</div>
                <div @click="changePriority('Normal')" hx-post="{% url 'update_status' item.id col.id %}"
                    hx-vals='{"action_value": "Normal"}' hx-target="#item-{{ item.id }}" hx-swap="outerHTML"
                    class="px-3 py-2 hover:bg-slate-50 text-slate-600 cursor-pointer text-xs font-medium">Normal</div>
            </div>
        </div>
        </div>

        {% elif col.type == 'person' %}
        <div x-data="{ open: false }" class="relative w-full h-full min-h-[40px] flex items-center justify-center">

            <!-- Assigned User Display -->
            <div @click="open = !open" class="cursor-pointer hover:bg-slate-100 p-1 rounded-full transition-colors">
                {% if val %}
                <div class="h-7 w-7 rounded-full bg-indigo-600 text-white flex items-center justify-center text-xs font-bold"
                    title="{{ val }}">
                    {{ val|slice:":2"|upper }}
                </div>
                {% else %}
                <div
                    class="h-7 w-7 rounded-full bg-slate-200 text-slate-400 flex items-center justify-center border border-dashed border-slate-300">
                    <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                    </svg>
                </div>
                {% endif %}
            </div>

            <!-- User Dropdown -->
            <div x-show="open" @click.outside="open = false" style="display: none;"
                class="absolute top-full left-1/2 transform -translate-x-1/2 w-[200px] z-50 bg-white rounded-lg shadow-xl border border-slate-200 py-1 mt-1">
                <div class="px-3 py-2 text-xs font-semibold text-slate-500 border-b border-slate-100">Assign to...</div>

                <!-- Users Loop (Requires 'users' in context, we added this to board_detail view) -->
                {% for member in users %} <!-- accessed via global context if passed, or explicit include -->
                <div @click="open = false" hx-post="{% url 'update_status' item.id col.id %}"
                    hx-vals='{"action_value": "{{ member.user.username }}"}' hx-target="#item-{{ item.id }}"
                    hx-swap="outerHTML" class="px-3 py-2 hover:bg-indigo-50 cursor-pointer flex items-center gap-2">
                    <div
                        class="h-6 w-6 rounded-full bg-slate-600 text-white flex items-center justify-center text-[10px]">
                        {{ member.user.username|slice:":1"|upper }}
                    </div>
                    <span class="text-sm text-slate-700">{{ member.user.username }}</span>
                </div>
                {% endfor %}
            </div>
        </div>



        {% elif col.type == 'date' %}
        <div class="h-full px-2 flex items-center justify-center">
            <input type="date" value="{{ val|default:'' }}" hx-post="{% url 'update_status' item.id col.id %}"
                hx-trigger="change" hx-target="#item-{{ item.id }}" hx-swap="outerHTML" name="action_value"
                class="bg-transparent border-none text-sm text-slate-600 focus:ring-0 p-0 text-center w-full cursor-pointer hover:bg-slate-50 rounded">
        </div>

        {% else %}
        <div
            class="h-full min-h-[40px] px-2 flex items-center justify-center truncate hover:bg-slate-50 text-sm text-slate-700">
            {{ val }}
        </div>
        {% endif %}
        {% endwith %}
    </td>
    {% endfor %}
    <td class="px-4 py-2 text-center">
        <button class="text-slate-400 hover:text-red-500 transition-colors">
            <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
        </button>
    </td>
</tr>